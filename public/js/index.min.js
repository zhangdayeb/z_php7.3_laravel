jQuery(function() {
    $("body").on("click", "[data-stopPropagation]", function(e) {
        e.stopPropagation();
    });

    // 滚动条
    const ps = new PerfectScrollbar(".lyear-layout-sidebar-scroll", {
        swipeEasing: false,
        suppressScrollX: true
    });

    // 侧边栏
    $(".lyear-aside-toggler").bind("click", function() {
        $(".lyear-layout-sidebar").toggleClass("lyear-aside-open");
        $("body").toggleClass("lyear-layout-sidebar-close");

        if ($(".lyear-mask-modal").length == 0) {
            $('<div class="lyear-mask-modal"></div>').prependTo("body");
        } else {
            $(".lyear-mask-modal").remove();
        }
        $(".lyear-mask-modal").on("click", function() {
            $(this).remove();
            $(".lyear-layout-sidebar").toggleClass("lyear-aside-open");
            $("body").toggleClass("lyear-layout-sidebar-close");
        });
    });

    // 侧边栏导航
    $(".nav-item-has-subnav > a").on("click", function() {
        $subnavToggle = jQuery(this);
        $navHasSubnav = $subnavToggle.parent();
        $topHasSubNav = $subnavToggle.parents(".nav-item-has-subnav").last();
        $subnav = $navHasSubnav.find(".nav-subnav").first();
        $viSubHeight = $navHasSubnav
            .siblings()
            .find(".nav-subnav:visible")
            .outerHeight();
        $scrollBox = $(".lyear-layout-sidebar-scroll");
        $navHasSubnav
            .siblings()
            .find(".nav-subnav:visible")
            .slideUp(500)
            .parent()
            .removeClass("open");
        $subnav.slideToggle(300, function() {
            $navHasSubnav.toggleClass("open");

            // 新增滚动条处理
            var scrollHeight = 0;
            (pervTotal = $topHasSubNav.prevAll().length),
                (boxHeight = $scrollBox.outerHeight()),
                (innerHeight = $(".sidebar-main").outerHeight()),
                (thisScroll = $scrollBox.scrollTop()),
                (thisSubHeight = $(this).outerHeight()),
                (footHeight = 121);

            if (footHeight + innerHeight - boxHeight >= pervTotal * 48) {
                scrollHeight = pervTotal * 48;
            }
            if ($subnavToggle.parents(".nav-item-has-subnav").length == 1) {
                $scrollBox.animate({ scrollTop: scrollHeight }, 300);
            } else {
                // 子菜单操作
                if (
                    typeof $viSubHeight != "undefined" &&
                    $viSubHeight != null
                ) {
                    scrollHeight = thisScroll + thisSubHeight - $viSubHeight;
                    $scrollBox.animate({ scrollTop: scrollHeight }, 300);
                } else {
                    if (
                        thisScroll + boxHeight - $scrollBox[0].scrollHeight ==
                        0
                    ) {
                        scrollHeight = thisScroll - thisSubHeight;
                        $scrollBox.animate({ scrollTop: scrollHeight }, 300);
                    }
                }
            }
        });
    });

    getTheme = function(data_name) {};

    // 如果body上有主题属性
    if ($("body").attr("data-logobg")) {
        var logobg = $("body").attr("data-logobg");
        $('.dropdown-skin input[name="logo_bg"]')
            .removeAttr("checked")
            .filter("[value=" + logobg + "]")
            .prop("checked", "checked");
    }

    if ($("body").attr("data-headerbg")) {
        var header_bg = $("body").attr("data-headerbg");
        $('.dropdown-skin input[name="header_bg"]')
            .removeAttr("checked")
            .filter("[value=" + header_bg + "]")
            .prop("checked", "checked");
    }

    if ($("body").attr("data-sidebarbg")) {
        var sidebar_bg = $("body").attr("data-sidebarbg");
        $('.dropdown-skin input[name="sidebar_bg"]')
            .removeAttr("checked")
            .filter("[value=" + sidebar_bg + "]")
            .prop("checked", "checked");
    }

    // 设置主题配色
    setTheme = function(input_name, data_name) {
        $("input[name='" + input_name + "']").click(function() {
            $("body").attr(data_name, $(this).val());
        });
    };
    setTheme("logo_bg", "data-logobg");
    setTheme("header_bg", "data-headerbg");
    setTheme("sidebar_bg", "data-sidebarbg");

    // 获取默认首页信息
    var defaultPage = $(".sidebar-main .active > .multitabs");
    // console.log(defaultPage.innerHTML);

    // 选项卡
    $("#iframe-content").multitabs({
        iframe: true,
        nav: {
            backgroundColor: "#ffffff",
            maxTabs: 35 // 选项卡最大值
        },
        /*
        init: [
            {
                type: "main",
                title: "首页",
                url: "lyear_main.html"
            }
        ]
        */
        init: [
            {
                type: "main",
                title: defaultPage.find("span").html(),
                url: defaultPage.attr("href")
            }
        ]
    });

    $(".nav-item .multitabs").bind("click", function() {
        $(".nav-item").removeClass("active");
        $(".nav-subnav li").removeClass("active");
        $(this)
            .parent("li")
            .addClass("active");
        $(this)
            .parents(".nav-item-has-subnav")
            .addClass("open")
            .first()
            .addClass("active");
    });

    // 首页定时查询未处理消息
    function showNotice() {
        /**
        return layer.confirm($(".notice-layer").html(), {
            btn: ["关闭"],
            shade: 0,
            anim: 2,
            title: "您有新的信息请及时处理",
            offset: "rb",
            success: function(layero, index) {
                $(layero)
                    .find("a")
                    .click(function() {
                        layer.close(index);
                    });
            },
            end: function() {
                $(".notice-layer").data("show", 0);
            }
            // area:['360px','280px']
        });
         */

        return layer.open({
            type:1,
            btn: ["关闭"],
            shade: 0,
            anim: 2,
            title: $.utils.getLangs('new_msg_notice'),
            offset: "rb",
            content:$(".notice-layer").html(),
            success: function(layero, index) {

                $(".notice-layer").data("show", index);
                $(layero)
                    .find("a")
                    .click(function() {
                        layer.close(index);
                    });

            },
            // end: function() {
            //     $(".notice-layer").data("show", 0);
            // }
        });
    }

    // 循环开启声音

    if ($(".notice-layer").length > 0) {
        tk_timer = setInterval(function() {
            var $dom = $(".notice-layer");
            /**
            $.post(
                $dom.data("url"),
                { loading: false },
                function(response) {

                },
                "json"
            );
             **/

            $.ajax({
                type: 'POST',
                url: $dom.data("url"),
                data: {loading: false},
                success:function(response){
                    var data = response.data;

                    changeNumAndPlay($dom.find("#rechargeNum"), 'recharge',data.recharge,data.notices);
                    changeNumAndPlay($dom.find("#drawingNum"), 'drawing',data.drawing ,data.notices);
                    changeNumAndPlay($dom.find("#messageNum"), 'message',data.message ,data.notices);
                    changeNumAndPlay($dom.find("#agentAppliesNum"), 'agent_apply',data.agent_apply ,data.notices);
                    changeNumAndPlay($dom.find("#memberNum"), 'member',data.member ,data.notices);
                    changeNumAndPlay($dom.find("#yuebaoNum"), 'yuebao',data.yuebao ,data.notices);
                    changeNumAndPlay($dom.find("#activityNum"), 'activity',data.activity,data.notices);
                    changeNumAndPlay($dom.find('#creditAppliesNum'), 'credit_apply', data.credit_apply, data.notices);
                    changeNumAndPlay($dom.find('#creditOverdueNum'), 'credit_overdue', data.credit_overdue, data.notices);

                    // 如果都不存在，则不显示弹窗
                    if (
                        !(
                            data.recharge ||
                            data.drawing ||
                            data.message ||
                            data.agent_apply || data.member || data.yuebao || data.activity || data.credit_apply || data.credit_overdue
                        )
                    )
                        return;

                    // 如果开启了弹窗提醒
                    if($(".notice-layer").data('alert-on')){
                        // 如果不存在，则显示
                        if (!$dom.data("show")) {
                            showNotice();
                        }else{
                            // 如果存在，则重新打开
                            layer.close($dom.data("show"));
                            showNotice();
                        }
                    }
                },
                error:function(err){
                    console.log(err);
                }
            });

        }, 10000);
    }

    /**
     *
     * @param $dom html文字
     * @param name
     * @param number 提醒数量
     * @param list
     */
    function changeNumAndPlay($dom, name ,number,list){
        // console.log($dom,name,number,list)
        $dom.html(number);

        if(number > 0 && $(".notice-layer").data('voice-on') && $dom.data('name') && $('#'+$dom.data('name')).length ){
            var sec = list.split(',').indexOf(name);
            sec = sec ? sec + 1 : 2;
            sec = sec * 2;

            setTimeout(function(){
                try{
                    $('#'+$dom.data('name'))[0].play();
                }catch (e) {}
            },
                sec * 1000
                );
            // $dom.data('sec') * 1000
        }
    }
});
